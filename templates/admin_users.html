<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizVerse | Manage Users</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Dark Mode Support -->
    <link rel="stylesheet" href="/static/dark-mode.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <!-- Include Sidebar -->
    {% set active_page = 'users' %}
    {% include 'includes/admin_sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden md:ml-64">
        <!-- Topbar -->
        <header class="bg-white border-b border-gray-200 flex items-center justify-between p-4">
            <div class="flex items-center space-x-4">
                <i id="menuToggle" data-feather="menu" class="cursor-pointer text-gray-600 md:hidden"></i>
                <h2 class="text-lg font-semibold text-gray-800">Manage Users</h2>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Dark Mode Toggle -->
                <button id="darkModeToggle"
                    class="w-8 h-8 rounded-lg hover:bg-gray-100 flex items-center justify-center transition"
                    title="Toggle Dark Mode">
                    <i id="sunIcon" data-feather="sun" class="w-5 h-5"></i>
                    <i id="moonIcon" data-feather="moon" class="w-5 h-5" style="display: none;"></i>
                </button>
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 text-white flex items-center justify-center">
                    A</div>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    #</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Username</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Email</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Role</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Joined</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for user in users %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ loop.index }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ user.username }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-500">{{ user.email }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if user.is_admin %}
                                    <span
                                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Admin</span>
                                    {% else %}
                                    <span
                                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">User</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="deleteUser('{{ user.id }}')"
                                        class="text-red-600 hover:text-red-900 ml-4">Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        feather.replace();
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) return;

            try {
                const token = sessionStorage.getItem('access_token') || localStorage.getItem('access_token'); // Adjust based on where you store it
                // Note: For simple redirect apps without complex JS auth handling, we might rely on cookie/session. 
                // Since this app uses JWT in headers for APIs, we need to pass it, or reliance on session if implemented.
                // The current admin routes use @admin_required check which checks session OR jwt. 
                // Let's assume session based for page loads, but API might need token.
                // Actually, the refactored routes/admin.py uses @admin_required_decorator which checks JWT identity.
                // Wait, Admin.html works on SESSION logic in 'def admin_panel'.
                // But 'api' routes use JWT. We might need to mix them or switch to session for admin API actions.
                // For now let's try fetch.

                const response = await fetch(`/api/admin/user/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert(data.msg || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }
    </script>
    <script src="/static/dark-mode.js"></script>
</body>

</html>